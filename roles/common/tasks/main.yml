---

- name: get the username running the deploy
  become: false
  local_action: command whoami
  register: username_on_the_host
  tags:
    - debug

- name: Update apt cache
  become: true
  become_user: root
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: '{{ common_apt_cache_ttl }}'
  register: common_apt_update
  tags:
    - packages

- name: Install essential packages
  become: true
  become_user: root
  ansible.builtin.package:
    name: '{{ common_apt_packages }}'
    state: latest
  tags:
    - packages

  # TODO: Probably need to install libssl-dev

- name: Install extra packages
  become: true
  become_user: root
  ansible.builtin.package:
    name: '{{ common_apt_packages_extra }}'
    state: latest
  tags:
    - packages

- name: Update all packages
  become: true
  become_user: root
  ansible.builtin.apt:
      name: '*'
      state: latest
  when: common_apt_update.changed
  tags:
    - packages

- name: Ensure git name and email set
  ansible.builtin.fail: msg="git name and email required"
  when:
    - common_git_name is undefined
      or common_git_email is undefined
      or not (common_git_email and common_git_name)
  tags:
    - git

- name: Set git name
  community.general.git_config:
    name: user.name
    value: '{{ common_git_name }}'
    scope: global
  tags:
    - git

- name: Set git email
  community.general.git_config:
    name: user.email
    value: '{{ common_git_email }}'
    scope: global
  tags:
    - git

- name: ensures .ssh conf dir exists
  file:
    path: '{{ common_user_home }}/.ssh'
    state: directory
  tags:
    - ssh

- name: Generate secret
  community.crypto.openssh_keypair:
    type: '{{ common_user_ssh_type}}'
    path: '{{ common_user_home }}/.ssh/id_{{ common_user_ssh_type }}'
  tags:
    - ssh
